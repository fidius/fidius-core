module FIDIUS
  module Action
    module PostExploit

      autoload :GetInterfaces,     'fidius/action/postexploit/getinterfaces'
      autoload :DetectWebserver,   'fidius/action/postexploit/detect_web_server'
      autoload :InjectIframe,      'fidius/action/postexploit/inject_iframe'

      module PostExploit
        include FIDIUS::Action

        # Runs the post exploit on the given meterpreter session.
        #
        # @return [boolean]
        def run session, host
        end

        # Returns true if this post exploit need root or admin rights to run.
        #
        # @return [boolean]
        def needs_root
          false
        end

        def self.autorun
          false
        end

      end #class PostExploit

      class PostExploitList

        def get name
          @list[name]
        end

        def initialize
          @list = {}
          @autorun = []
          add_postexploit FIDIUS::Action::PostExploit::GetInterfaces
          add_postexploit FIDIUS::Action::PostExploit::DetectWebserver
          add_postexploit FIDIUS::Action::PostExploit::InjectIframe
        end

        def add_postexploit postexploit
          @list = @list.merge({postexploit.name => postexploit})
          @autorun << postexploit if postexploit.autorun
        end

        attr_accessor :autorun
      end

      def self.run sessionID, name
        session = FIDIUS::Action::Msf.instance.framework.sessions[sessionID]
        raise RuntimeError, "can not get session for #{sessionID} available: #{FIDIUS::Action::Msf.instance.framework.sessions}" unless session
        run_onSession session, name
      end

      def self.run_onSession session, name
        postexpl = (@postExploits.get name).new
        raise RuntimeError, "wrong post exploit name" unless postexpl
        session.load_stdapi
        session.load_priv if postexpl.needs_root
        host = get_host_for_session session
        postexpl.run session, host
      end

      def self.autorun session
        @postExploits.autorun.each do |postexploit|
          run_onSession session, postexploit.name
        end
      end

private

      @postExploits = PostExploitList.new

      def self.get_host_for_session session
        ip = nil
        host = nil
        config = session.net.config
        config.each_interface do |interface|
          next if interface.ip == "127.0.0.1"
          ip = interface.ip
          inter = FIDIUS::Asset::Interface.find_by_ip(ip)
          host = inter.host if inter
          break if host
        end
        return host if host
        return FIDIUS::Asset::Host.find_or_create_by_ip(ip) if ip
      end

    end #module PostExploit
  end #module Action
end #module FIDIUS
