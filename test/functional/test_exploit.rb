require 'test_helper_fidius'
require 'test_helper_function'
require 'active_support/testing/assertions'

class ExploitTest < FIDIUS::Test
 include ActiveSupport::Testing::Assertions
  def test_pwn_host_mock
    FIDIUS::Action::Msf.instance.start
    lhost = FIDIUS::Asset::Host.find_or_create_by_ip "192.168.77.1"
    autopwner = FIDIUS::Action::Exploit::Exploit.instance
    h = FIDIUS::Asset::Host.find_or_create_by_ip "192.168.77.88"
    inter = h.find_or_create_by_ip "192.168.77.88"
    service = FIDIUS::Service.create
    service.port = 80
    inter.services << service
    assert_difference('FIDIUS::Session.all.count',+1) do
      result = autopwner.autopwn inter
    end
    h = FIDIUS::Asset::Host.find_by_ip "192.168.77.88"
    session = h.sessions.first
    assert_equal service.id, session.service_id
    assert_equal "payload/test", session.payload
    assert_equal "exploit/http", session.exploit
    assert_equal "1", session.name

    assert_equal "FIDIUS-69B8F53A", h.name
    assert_equal "Windows", h.os_name
    assert_equal "Windows XP (Build 2600, Service Pack 2).", h.os_info
    assert_equal "de_DE", h.lang
    assert_equal "SP2", h.os_sp
    assert_equal "x86", h.arch
  end
end
