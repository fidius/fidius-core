require 'test_helper_fidius'
require 'test_helper_integration'
require 'active_support/testing/assertions'

class ExploitTest < FIDIUS::Test
 include ActiveSupport::Testing::Assertions
  def setup
   super
   FIDIUS::Action::Msf.instance.start  if ENV['ENV'] == "test"
  end
  
  def teardown
    def teardown
      FIDIUS::Action::Msf.instance.stop  if ENV['ENV'] == "test"
      super
    end
  end
  
  def test_pwn_host
    vm_start vm_config[:xp_vm]
    autopwner = FIDIUS::Action::Exploit::Exploit.instance
    inter = vm_find_interface vm_config[:xp_vm]
    scan = FIDIUS::Action::Scan::PortScan.new(inter)
    target = scan.execute
    
    unless inter.host.exploited?
      assert_difference('FIDIUS::Session.all.count',+1) {
        result = autopwner.autopwn inter  
      }
    else
      assert_no_difference('FIDIUS::Session.all.count') {
        result = autopwner.autopwn inter  
      }
    end
    assert_equal inter.host.exploited?, true
  end
end
